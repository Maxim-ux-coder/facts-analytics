<!DOCTYPE html>
<html lang="hy">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ì’°’Ω’ø’•÷Ä ‚Äî 20 ’∞’°÷Ä÷Å’∏’æ ’£’∂’°’∞’°’ø’∏÷Ç’¥</title>
  <meta name="theme-color" content="#6c63ff">
  <!-- Favicons -->
  <link rel="icon" href="favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" href="boxk.png" sizes="48x48">
  <style>
    :root{
      --brand:#6c63ff; --brand-2:#584de0; --bg1:#eef5ff; --bg2:#fff7fb; --text:#1b1b1f; --muted:#636a73;
      --ok:#2e7d32; --meh:#f57c00; --bad:#e53935; --card:#fff; --radius:14px; --ring:#cbd5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:500 16px/1.6 "Segoe UI", Roboto, system-ui, -apple-system, Arial;color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    header{background:var(--brand);color:#fff;padding:18px;text-align:center;font-size:20px;position:sticky;top:0;z-index:10}
    .container{max-width:920px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 18px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    h1,h2,h3{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 16px;background:var(--brand);color:#fff;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--brand-2);transform:translateY(-1px)}
    .btn:focus-visible{outline:3px solid var(--ring)}
    .btn.ghost{background:#eef1ff;color:#333}
    .btn.danger{background:var(--bad)}
    .btn.flat{background:#f3f4f7;color:#111}
    input,textarea{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;width:100%}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f0f3ff;border:1px solid #dfe3ff;color:#333;margin-right:6px}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .tile{background:#f8f9ff;border:1px solid #e7ebff;border-radius:12px;padding:10px 12px}
    .progress{height:10px;background:#eef1ff;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#8ea2ff,#6c63ff);transition:width .25s}
    .rate button{margin:6px 6px 0 0;padding:10px 14px;border-radius:10px;border:0;color:#fff;cursor:pointer}
    .good{background:var(--ok)} .meh{background:var(--meh)} .bad{background:var(--bad)}
    kbd{background:#f5f6fb;border:1px solid #e1e5ff;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font:600 12px/1 "Segoe UI", system-ui}
    .footer-note{font-size:13px;color:#7a8291}
  </style>
</head>
<body>
  <header>’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ì’°’Ω’ø’•÷Ä ‚Äî 20 ÷É’°’Ω’ø</header>
  <div class="container" role="main">

    <!-- Welcome: keep name input; start always resets deck -->
    <section id="welcome" class="card" aria-labelledby="wl-title">
      <h2 id="wl-title">‘≤’°÷Ä’´ ’£’°’¨’∏÷Ç’Ω’ø üëã</h2>
      <p class="muted">‘≥÷Ä’´÷Ä ÷Ñ’∏ ’°’∂’∏÷Ç’∂’®’ù ’Ω’Ø’Ω’•’¨’∏÷Ç ’∞’°’¥’°÷Ä÷â ‘±’∂’∏÷Ç’∂’® <b>’â‘ª</b> ’∫’°’∞’∫’°’∂’æ’∏÷Ç’¥, ’∫’•’ø÷Ñ ’ß ’£÷Ä’•’¨ ’Ø÷Ä’Ø’´’∂, ’•’©’• ’©’°÷Ä’¥’°÷Å’∂’•’Ω ’ß’ª’®÷â</p>
      <div class="row" style="align-items:flex-end">
        <div style="flex:1 1 260px">
          <label for="nameInput" class="muted">‘±’∂’∏÷Ç’∂</label>
          <input id="nameInput" placeholder="÷Ö÷Ä. ‘±÷Ä’¥’•’∂" autocomplete="off" />
        </div>
        <button id="btnStart" class="btn">’ç’Ø’Ω’•’¨ üöÄ</button>
        <button id="btnReset" class="btn ghost">’Ñ’°÷Ñ÷Ä’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’®</button>
      </div>
      <p class="footer-note">Hotkeys: 1‚Äì5 ’£’∂’°’∞’°’ø’∏÷Ç’¥, ‚Üê/‚Üí ’°’∂÷Å’∏÷Ç’¥÷â ‘±’∂’∏÷Ç’∂’® ’Ø’°÷Ä’∏’≤ ’•’Ω ÷É’∏’≠’•’¨ ’£’∂’°’∞’°’ø’¥’°’∂ ’™’°’¥’°’∂’°’Ø ÷á ’æ’•÷Ä’ª’∏÷Ç’¥÷â</p>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden" aria-live="polite">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="muted">‘±’∂’∏÷Ç’∂</div>
            <div class="row">
              <div id="userName" class="pill">‘±’∂’°’∂’∏÷Ç’∂</div>
              <button class="btn flat" id="btnEditNameMid">’ì’∏’≠’•’¨ ’°’∂’∏÷Ç’∂’®</button>
            </div>
          </div>
          <div class="kpi">
            <div class="tile">’ë’∏÷Ç÷Å’°’§÷Ä’æ’°’Æ’ù <b id="shown">0/20</b></div>
            <div class="tile">‘ø’°’ø’•’£’∏÷Ä’´’°’ù <span id="catName">‚Äî</span></div>
          </div>
        </div>
        <div class="progress" aria-label="‘±’º’°’ª’®’∂’©’°÷Å"><span id="pg"></span></div>
      </div>

      <div class="card">
        <div class="muted" id="factCat">‚Äî</div>
        <h2 id="factText">‚Äî</h2>
        <div class="rate" aria-label="‘≥’∂’°’∞’°’ø’•’¨ ÷É’°’Ω’ø’®">
          <button class="good" onclick="rate(5)">üòç ’á’°’ø ’Ω’´÷Ä’•÷Å’´ <kbd>5</kbd></button>
          <button class="good" onclick="rate(4)">üëç ’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ß÷Ä <kbd>4</kbd></button>
          <button class="meh"  onclick="rate(3)">üòê ’Ü’∏÷Ä’¥’°’¨ <kbd>3</kbd></button>
          <button class="bad"  onclick="rate(2)">üëé ’â’ß <kbd>2</kbd></button>
          <button class="bad"  onclick="rate(1)">üö´ ‘ª’∂’± ’∞’°’¥’°÷Ä ’π’ß <kbd>1</kbd></button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" onclick="prevFact()">‚Üê ’Ü’°’≠’∏÷Ä’§’® <kbd>‚Üê</kbd></button>
          <button class="btn" onclick="nextFact()">’Ä’°’ª’∏÷Ä’§’® ‚Üí <kbd>‚Üí</kbd></button>
        </div>
      </div>
    </section>

    <!-- Finish -->
    <section id="finish" class="hidden">
      <div class="card">
        <h2>’á’∂’∏÷Ä’∞’°’Ø’°’¨’∏÷Ç’©’µ’∏÷Ç’∂ üôå</h2>
        <p class="muted">‘±’æ’°÷Ä’ø’•’¨’∏÷Ç÷Å ’°’º’°’ª ’Ø’°÷Ä’∏’≤ ’•’Ω <b>÷É’∏’≠’•’¨ ’°’∂’∏÷Ç’∂’®</b> ’∞’°’∑’æ’•’ø’æ’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä, ’°’æ’•’¨’°÷Å’∂’•’¨ ’°’º’°’ª’°÷Ä’Ø’∂’•÷Ä ÷á ’∂’•÷Ä’¢’•’º’∂’•’¨ TXT/JSON÷â</p>
      </div>

      <div class="card">
        <h3>‘±’∂’∏÷Ç’∂ ’∞’°’∑’æ’•’ø’æ’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä</h3>
        <div class="row">
          <input id="nameFinish" placeholder="÷Ö÷Ä. ‘±÷Ä’¥’•’∂" />
          <button class="btn flat" id="btnApplyFinish">‘ø’´÷Ä’°’º’•’¨</button>
        </div>
      </div>

      <div id="suggestions" class="card">
        <h3>‘±’º’°’ª’°÷Ä’Ø’∂’•÷Ä</h3>
        <div id="suggestList"></div>
        <button class="btn ghost" onclick="addSuggestion()">‚ûï ’Ü’∏÷Ä ’°’º’°’ª’°÷Ä’Ø</button>
      </div>

      <div class="card">
        <h3>‘±’æ’°÷Ä’ø’•’¨</h3>
        <div class="row">
          <button class="btn" onclick="downloadReport()">‚¨áÔ∏è TXT</button>
          <button class="btn" onclick="downloadJSON()">‚¨áÔ∏è JSON</button>
          <button class="btn ghost" onclick="reviewAnswers()">üìÑ ‘¥’´’ø’•’¨</button>
          <button class="btn flat" id="btnCopy">üìã ’ä’°’ø’≥’•’∂’•’¨</button>
        </div>
        <div id="reviewBox" class="muted" style="margin-top:10px;white-space:pre-wrap"></div>
      </div>
    </section>

  </div>

  <script>
    // ===== Helpers =====
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const readLS=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};
    const nowStr=()=>new Date().toLocaleString();

    // Seeded shuffle (LCG)
    function seededShuffle(arr, seedStr){
      let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31 + seedStr.charCodeAt(i))>>>0;
      let a=1664525, c=1013904223, m=2**32, x=seed||123456789;
      const out=arr.slice();
      for(let i=out.length-1;i>0;i--){
        x=(a*x+c)%m; const j = Math.floor((x/m)*(i+1)); [out[i],out[j]]=[out[j],out[i]];
      }
      return out;
    }

    // ===== Data =====
    const CATEGORIES=[
      {id:'science', name:'‘≥’´’ø’∏÷Ç’©’µ’∏÷Ç’∂'},
      {id:'history', name:'’ä’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂'},
      {id:'animals', name:'‘ø’•’∂’§’°’∂’´’∂’•÷Ä'},
      {id:'space', name:'’è’´’•’¶’•÷Ä÷Ñ'},
      {id:'tech', name:'’è’•’≠’∂’∏’¨’∏’£’´’°’∂’•÷Ä'}
    ];

    const FACTS = {
      science: [
        '’Ñ’°÷Ä’§’∏÷Ç ‘¥’Ü‘π-’´ ’°’¥’¢’∏’≤’ª ’•÷Ä’Ø’°÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®, ’•’©’• ’±’£’æ’•÷Ä, ’Ø’£’•÷Ä’°’¶’°’∂÷Å’•÷Ä ‘±÷Ä’•’£’°’Ø’´÷Å ’¥’´’∂’π÷á ’ä’¨’∏÷Ç’ø’∏’∂ ’∞’•’º’°’æ’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®÷â',
        '’ç÷Ä’ø’´ ’¢’°’¢’°’≠’µ’∏÷Ç’∂’® ’Ø’°÷Ä’∏’≤ ’ß ÷É’∏’≠’•’¨ ’¥’°÷Ä’§’∏÷Ç ’∏÷Ç’≤’•’≤’´ ’°’¨’´÷Ñ’∂’•÷Ä’® ÷á ’°’¶’§’•÷Å’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’•’∂’°’¨ ’∞’´’∑’∏’≤’∏÷Ç’©’µ’°’∂ ’æ÷Ä’°÷â',
        '’Ñ’°’Ø’•÷Ä’•’Ω’°’µ’´’∂ ’¨’°÷Ä’æ’∏’≤’∏÷Ç’©’µ’°’∂ ’∫’°’ø’≥’°’º’∏’æ ÷É’∏÷Ñ÷Ä ’¥’´’ª’°’ø’∂’•÷Ä’® ’Ø’°÷Ä’∏’≤ ’•’∂ ÷Ñ’°’µ’¨’•’¨ ’ª÷Ä’´ ’æ÷Ä’°÷â',
        '’Ñ’°÷Ä’§’∏÷Ç ’Ω’ø’°’¥’∏÷Ñ’Ω’® ’µ’∏÷Ç÷Ä’°÷Ñ’°’∂’π’µ’∏÷Ç÷Ä ’¥’´ ÷Ñ’°’∂’´ ÷Ö÷Ä ÷É’∏’≠’∏÷Ç’¥ ’ß ’¨’∏÷Ä’±’°’©’°’≤’°’∂’©’®, ’∏÷Ä ’π’∞’°’¨’π’´ ’Ω’•÷É’°’Ø’°’∂ ’©’©’æ’´÷Å÷â',
        '‘ø’•’∂’Ω’°’¢’°’∂’°’Ø’°’∂ ’ø’•’Ω’°’∂’Ø’µ’∏÷Ç’∂’´÷Å ’¥’°÷Ä’§’Ø’°’∂÷Å ‘¥’Ü‘π-’∂ 60%-’∏’æ ’∂’¥’°’∂ ’ß ’¢’°’∂’°’∂’´ ‘¥’Ü‘π-’´’∂÷â'
      ],
      history: [
        '’Ä’´’∂ ‘µ’£’´’∫’ø’∏’Ω’∏÷Ç’¥ ’°’º’°’ª’´’∂ ’∞’°’µ’ø’∂’´ ’∫’°’µ’¥’°’∂’°’£÷Ä’•÷Ä’® ’Ø’∂÷Ñ’æ’•’¨ ’•’∂ ’§’•’º÷á’Ω ’¥.’©.’°. 3000-’´’∂÷â',
        '‘±’¨’•÷Ñ’Ω’°’∂’§÷Ä ’Ñ’°’Ø’•’§’∏’∂’°÷Å’´’∂ ’∞’´’¥’∂’°’§÷Ä’•’¨ ’ß ’°’æ’•’¨’´ ÷Ñ’°’∂ 20 ÷Ñ’°’≤’°÷Ñ ’´÷Ä ’°’∂’∏÷Ç’∂’∏’æ’ù ‘±’¨’•÷Ñ’Ω’°’∂’§’°’∫’∏’¨÷â',
        '’Ä’´’∂ ’Ä’º’∏’¥’∏÷Ç’¥ ’¥’•’ø’°’≤’°’§÷Ä’°’¥’∂’•÷Ä’∏’æ ’°’∑’≠’°’ø’°’æ’°÷Ä’± ’Ω’ø’°÷Å’∏’≤ ’¶’´’∂’æ’∏÷Ä’∂’•÷Ä’´’∂ ’°’Ω’∏÷Ç’¥ ’ß’´’∂ ¬´’Ω’°’¨’°÷Ä’´’∏÷Ç’¥¬ª (’°’≤’´ ’£’∏÷Ç’¥’°÷Ä)÷â',
        '’Ñ’´’ª’∂’°’§’°÷Ä’∏÷Ç’¥ ’Ø’°’ø’∏÷Ç’∂’•÷Ä’´’∂ ’•÷Ä’¢’•’¥’∂ ’§’°’ø’∏÷Ç’¥ ’ß’´’∂ ’∏÷Ä’∫’•’Ω ¬´’∞’°’∂÷Å’°’£’∏÷Ä’Æ¬ª÷â',
        '‘±÷Ä’ø’°’∑’°’ø’® ’∞’°’µ’ø’∂’´ ’ß÷Ä ’∏÷Ä’∫’•’Ω ¬´’Ä’°’µ’Ø’°’Ø’°’∂ ‘ø’°÷Ä’©’°’£’•’∂¬ª’ù ’¥’•’Æ ’°’º÷á’ø÷Ä’°’Ø’°’∂ ’Ø’•’∂’ø÷Ä’∏’∂ ’¨’´’∂’•’¨’∏’æ÷â'
      ],
      animals: [
        '‘±÷Ñ’¨’∏÷Ä’∂’•÷Ä’® ’Ø’°÷Ä’∏’≤ ’•’∂ ’¨’Ω’•’¨ ’¥’´’∂’π÷á 85 ’Ø’Ä÷Å ’¢’°÷Ä’±÷Ä ’∞’°’≥’°’≠’°’Ø’°’∂’∏÷Ç’©’µ’°’∂ ’±’°’µ’∂’•÷Ä, ’∏÷Ä’® ’¥’°÷Ä’§’´’Ø ’π’•’∂ ’®’∂’Ø’°’¨’∏÷Ç’¥÷â',
        '‘≥’∂’§’°’Ø’°’±÷á ’±’Ø’∂’´’Ø’∂’•÷Ä’® ’∏÷Ç’∂’•’∂ ’©’∏÷Ç’µ’∂, ’∏÷Ä’∂ ’°’æ’•’¨’´ ’¥’°’∞’°÷Å’∏÷Ç ’ß, ÷Ñ’°’∂ ÷Å’´’°’∂’´’§’®÷â',
        '’ì’´’≤’® ’¥’´’°’Ø ’Ø’•’∂’§’°’∂’´’∂ ’ß, ’∏÷Ä’® ’π’´ ’Ø’°÷Ä’∏’≤ ÷Å’°’ø’Ø’•’¨÷â',
        '’ä’´’∂’£’æ’´’∂’∂’•÷Ä’´ ’¶’∏÷Ç’µ’£’•÷Ä’® ’∞’°’≥’°’≠ ’£’ø’∂’∏÷Ç’¥ ’•’∂ ’´÷Ä’°÷Ä ’∞’°’ø’∏÷Ç’Ø ¬´’Ω’´÷Ä’∏ ’Ø’°’∂’π’∏’æ¬ª÷â',
        '‘ø’°÷Ä’¥’´÷Ä ’∫’°’∂’§’°’∂ ’´÷Ä’°’Ø’°’∂’∏÷Ç’¥ ’°’æ’•’¨’´ ’¥’∏’ø ’ß ’ß’∂’§’•’¥’´’Ø ’Ø’•’∂’§’°’∂’´’∂’•÷Ä’´’∂, ÷Ñ’°’∂ ’¥’•’Æ ’∫’°’∂’§’°’∂’•÷Ä’´’∂÷â'
      ],
      space: [
        '‘±÷Ä’•’£’°’Ø’∂ ’µ’∏÷Ç÷Ä’°÷Ñ’°’∂’π’µ’∏÷Ç÷Ä ’æ’°’µ÷Ä’Ø’µ’°’∂’∏÷Ç’¥ ÷É’∏’≠’°÷Ä’Ø’∏÷Ç’¥ ’ß ’¥’∏’ø 600 ’¥’´’¨’´’∏’∂ ’ø’∏’∂’∂’° ’∞’•’¨’´’∏÷Ç’¥’´ ’ª÷Ä’°’Æ’´’∂÷â',
        '’ç’°’ø’∏÷Ç÷Ä’∂’´ ÷Ö’≤’°’Ø’∂’•÷Ä’® ’¢’°’≤’Ø’°÷Å’°’Æ ’•’∂ ’∞’´’¥’∂’°’Ø’°’∂’∏÷Ç’¥ ’Ω’°’º’∏÷Ç’µ÷Å’´÷Å ÷á ÷É’∏’∑’∏÷Ç÷Å÷â',
        '’Ñ’´’ª’°’¶’£’°’µ’´’∂ ’ø’´’•’¶’•÷Ä’°’Ø’°’µ’°’∂’´ ’°÷Ä’°’£’∏÷Ç’©’µ’∏÷Ç’∂’® ’¥’∏’ø 28 000 ’Ø’¥/’™ ’ß÷â',
        '’Ö’∏÷Ç’∫’´’ø’•÷Ä’´ ’Ñ’•’Æ ‘ø’°÷Ä’¥’´÷Ä ‘ø’•’ø’® ÷É’∏’©’∏÷Ä’´’Ø ’ß, ’∏÷Ä’® ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´ ’°’º’∂’æ’°’¶’∂ 350 ’ø’°÷Ä’´÷â',
        '’è’´’•’¶’•÷Ä÷Ñ’∏÷Ç’¥ ’¨’°÷Å ’¨’´’∂’•’¨’∏÷Ç ’§’•’∫÷Ñ’∏÷Ç’¥ ’°÷Ä÷Å’∏÷Ç’∂÷Ñ’∂’•÷Ä’® ’π’•’∂ ’∞’∏’Ω’∏÷Ç’¥, ’°’µ’¨ ’¥’∂’∏÷Ç’¥ ’•’∂ ’°’π÷Ñ’•÷Ä’´ ’æ÷Ä’° ’∏÷Ä’∫’•’Ω ’£’∂’§’´’Ø’∂’•÷Ä÷â'
      ],
      tech: [
        '‘±’º’°’ª’´’∂ ’∞’°’¥’°’Ø’°÷Ä’£’π’°’µ’´’∂ ’¥’Ø’∂’´’Ø’® ’∫’°’ø÷Ä’°’Ω’ø’æ’°’Æ ’ß÷Ä ÷É’°’µ’ø’´÷Å (1964’©.)÷â',
        'Google ’°’∂’∏÷Ç’∂’® ’£’°’¨’´’Ω ’ß ¬´googol¬ª ’¢’°’º’´÷Å’ù ’Ø’°’¥’æ’°’Æ 1-’´÷Å ÷á 100 ’¶÷Ä’∏’µ’´÷Å÷â',
        '‘±’º’°’ª’´’∂ ’Ø’∏’∑’ø ’Ω’Ø’°’æ’°’º’°’Ø’® ’Ø’∑’º’∏÷Ç’¥ ’ß÷Ä ’°’æ’•’¨’´ ÷Ñ’°’∂ ’¥’•’Ø ’ø’∏’∂’∂’° ÷á ’∫’°’∞’∏÷Ç’¥ ’ß÷Ä ’®’∂’§’°’¥’•’∂’® 5 ’Ñ‘≤ ’ø’æ’µ’°’¨÷â',
        'Bluetooth ’°’∂’∏÷Ç’∂’® ’æ’•÷Ä÷Å’æ’°’Æ ’ß ’Ω’Ø’°’∂’§’´’∂’°’æ’µ’°’∂ ’©’°’£’°’æ’∏÷Ä’´÷Å’ù ’Ä’°÷Ä’°’¨’§ ‘ø’°’∫’ø’°’∂’°’ø’°’≠’ø’°’Ø’´÷Å÷â',
        '‘±’º’°’ª’´’∂ iPhone-’® ’π’ß÷Ä ’°’ª’°’Ø÷Å’∏÷Ç’¥ ¬´copy-paste¬ª ÷Ü’∏÷Ç’∂’Ø÷Å’´’°’∂÷â'
      ]
    };

    // ===== State (name is NOT persisted) =====
    const EMPTY = ()=>({
      name: '', deck: [], idx: 0, answers: [], suggestions: [''], finished:false
    });

    let state = readLS('ff_state') || EMPTY();
    // Drop any persisted name to follow the rule
    state.name = '';

    function persist(){
      // Save everything EXCEPT name
      const copy = {...state, name:''};
      saveLS('ff_state', copy);
    }

    // ===== Deck generation (20 = 5√ó4) =====
    function buildDeck(){
      const nm = state.name || 'guest';
      const cats=CATEGORIES.map(c=>c.id);
      const deck=[];
      for(const cat of cats){
        const pool = FACTS[cat].slice();
        const shuffled = seededShuffle(pool, nm);
        const take4 = shuffled.slice(0,4);
        for(let i=0;i<take4.length;i++){
          deck.push({ id:`${cat}_${i}`, cat, text: take4[i] });
        }
      }
      state.deck = seededShuffle(deck, nm);
      state.idx = 0; state.answers = []; state.finished=false;
      persist();
    }

    // ===== UI flow =====
    function startApp(){
      const nm = ($('#nameInput').value||'').trim();
      if(!nm){ alert('‘≥÷Ä’´’õ÷Ä ’°’∂’∏÷Ç’∂’® ‚úçÔ∏è'); return; }
      // ALWAYS start fresh after submitting the name
      state = EMPTY();
      state.name = nm;
      buildDeck();
      $('#userName').textContent = nm;
      $('#shown').textContent = '0/20';
      $('#welcome').classList.add('hidden');
      $('#quiz').classList.remove('hidden');
      updateProgress();
      showCurrent();
      persist();
    }

    function editNameInline(){
      const nm = prompt('’Ü’∏÷Ä ’°’∂’∏÷Ç’∂’®', state.name||'');
      if(nm===null) return;
      const newName = nm.trim();
      if(!newName){ alert('‘±’∂’∏÷Ç’∂’® ’π’´ ’Ø’°÷Ä’∏’≤ ’¨’´’∂’•’¨ ’§’°’ø’°÷Ä’Ø÷â'); return; }
      const keepRatings = confirm('’ä’°’∞’•’û’¨ ’®’∂’©’°÷Å’´’Ø ’£’∂’°’∞’°’ø’°’Ø’°’∂’∂’•÷Ä’® (re-seed ’®’Ω’ø ’∂’∏÷Ä ’°’∂’∏÷Ç’∂’´)÷â OK’ù ’∫’°’∞’•’¨, Cancel’ù ’Ω’Ø’Ω’•’¨ ’¶÷Ä’∏’µ’´÷Å÷â');
      state.name = newName;
      if(keepRatings){
        const oldAnswers = state.answers.slice();
        buildDeck();
        const map = new Map(oldAnswers.filter(Boolean).map(a=>[a.text,a.rating]));
        state.answers = state.deck.map(it => map.has(it.text) ? {...it, rating: map.get(it.text)} : undefined);
      }else{
        buildDeck();
      }
      $('#userName').textContent = state.name;
      updateProgress();
      showCurrent();
      persist();
    }

    function applyFinishName(){
      const nm = ($('#nameFinish').value||'').trim();
      if(!nm){ alert('‘≥÷Ä’´’õ÷Ä ’°’∂’∏÷Ç’∂’® ’∞’°’∑’æ’•’ø’æ’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä'); return; }
      state.name = nm; // still not persisted
      $('#userName').textContent = nm;
      reviewAnswers();
    }

    function showCurrent(){
      if(state.idx >= state.deck.length){ finishFlow(); return; }
      const item = state.deck[state.idx];
      const catName = CATEGORIES.find(c=>c.id===item.cat).name;
      $('#catName').textContent = catName;
      $('#factCat').textContent = catName;
      $('#factText').textContent = item.text;
      $('#shown').textContent = `${Math.min(state.idx+1,20)}/20`;
      updateProgress();
    }

    function updateProgress(){
      const done = state.answers.filter(a=>a && a.rating>0).length;
      const pct = Math.round((done/20)*100);
      $('#pg').style.width = pct+'%';
    }

    function nextFact(){
      if(state.idx < state.deck.length-1){ state.idx++; showCurrent(); persist(); }
      else { finishFlow(); }
    }
    function prevFact(){
      if(state.idx>0){ state.idx--; showCurrent(); persist(); }
    }

    function rate(q){
      const item = state.deck[state.idx];
      state.answers[state.idx] = { ...item, rating:q };
      persist();
      nextFact();
    }

    function finishFlow(){
      state.finished=true; persist();
      $('#quiz').classList.add('hidden');
      $('#finish').classList.remove('hidden');
      if(!state.suggestions || !state.suggestions.length) state.suggestions=[''];
      // prefill finish name with current (not persisted)
      $('#nameFinish').value = state.name || '';
      renderSuggestions();
      reviewAnswers();
      window.onbeforeunload = null;
    }

    // ===== Suggestions =====
    function renderSuggestions(){
      const box = $('#suggestList'); box.innerHTML='';
      state.suggestions.forEach((val, i)=>{
        const wrap=document.createElement('div'); wrap.className='row'; wrap.style.margin='8px 0';
        const label=document.createElement('div'); label.textContent=`‘±’º’°’ª’°÷Ä’Ø ${i+1}`; label.style.minWidth='110px'; label.className='muted';
        const input=document.createElement('input'); input.value=val; input.placeholder='’Å’•÷Ä ’°’º’°’ª’°÷Ä’Ø’®‚Ä¶';
        input.oninput=()=>{ state.suggestions[i]=input.value; persist(); };
        const rm=document.createElement('button'); rm.className='btn danger'; rm.textContent='‚úï';
        rm.onclick=()=>{ state.suggestions.splice(i,1); renderSuggestions(); persist(); };
        wrap.appendChild(label); wrap.appendChild(input); wrap.appendChild(rm);
        box.appendChild(wrap);
      });
    }
    function addSuggestion(){ state.suggestions.push(''); renderSuggestions(); persist(); }

    // ===== Report =====
    function catMap(){ const m={}; for(const c of CATEGORIES){ m[c.id]={name:c.name,sum:0,n:0}; } return m; }

    function buildReportText(){
      const lines=[]; const now=nowStr();
      lines.push(`‘±’∂’∏÷Ç’∂: ${state.name || '‘±’∂’°’∂’∏÷Ç’∂'}`);
      lines.push(`‘±’¥’Ω’°’©’´’æ/’™’°’¥: ${now}`);
      lines.push('');
      const perCat=catMap();
      state.answers.forEach(a=>{ if(!a) return; perCat[a.cat].sum+=a.rating||0; perCat[a.cat].n++; });
      lines.push('‘ø’°’ø’•’£’∏÷Ä’´’°’∂’•÷Ä’´ ’°’¥÷É’∏÷É’∏÷Ç’¥:');
      let bestCat=null, bestAvg=-1;
      for(const cid of Object.keys(perCat)){
        const {name,sum,n}=perCat[cid]; const avg = n? (sum/n).toFixed(2) : '‚Äî';
        lines.push(`- ${name}: ’¥’´’ª’´’∂ ${avg} (${n} ÷É’°’Ω’ø)`);
        if(n){ const v=sum/n; if(v>bestAvg){ bestAvg=v; bestCat=name; } }
      }
      lines.push(`‘º’°’æ’°’£’∏÷Ç’µ’∂ ’Ø’°’ø’•’£’∏÷Ä’´’°: ${bestCat||'‚Äî'}`);
      lines.push('');
      lines.push('’Ñ’°’∂÷Ä’°’¥’°’Ω’∂’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä (20 ÷É’°’Ω’ø) ‚Äî ’Ø’°÷Ä’£’∏’æ:');
      state.deck.forEach((it, i)=>{
        const a = state.answers[i];
        const catName = CATEGORIES.find(c=>c.id===it.cat).name;
        const r = a? a.rating : '‚Äî';
        lines.push(`${String(i+1).padStart(2,'0')}. [${catName}] ${it.text} => ‘≥’∂’°’∞’°’ø’°’Ø’°’∂: ${r}`);
      });
      lines.push('');
      lines.push('‘±’º’°’ª’°÷Ä’Ø’∂’•÷Ä:');
      const nonEmpty=(state.suggestions||[]).map(s=>s.trim()).filter(Boolean);
      if(nonEmpty.length){ nonEmpty.forEach((s,i)=> lines.push(`- ${i+1}) ${s}`)); }
      else { lines.push('‚Äî'); }
      return lines.join('\n');
    }

    function buildReportJSON(){
      const perCat=catMap();
      state.answers.forEach(a=>{ if(!a) return; perCat[a.cat].sum+=a.rating||0; perCat[a.cat].n++; });
      const stats = Object.entries(perCat).map(([cid,{name,sum,n}])=>({id:cid,name,avg:n?sum/n:null,count:n}));
      const best = stats.filter(s=>s.count>0).sort((a,b)=>b.avg-a.avg)[0]?.name || null;
      return {
        name: state.name || null,
        timestamp: new Date().toISOString(),
        deck: state.deck,
        answers: state.answers,
        suggestions: (state.suggestions||[]).filter(s=>s && s.trim()),
        stats: { perCategory: stats, bestCategory: best }
      };
    }

    function download(blob, filename){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }
    function downloadReport(){
      const txt = buildReportText();
      download(new Blob([txt], {type:'text/plain;charset=utf-8'}), `facts_report_${(state.name||'user').replace(/\s+/g,'_')}.txt`);
    }
    function downloadJSON(){
      const json = JSON.stringify(buildReportJSON(), null, 2);
      download(new Blob([json], {type:'application/json'}), `facts_report_${(state.name||'user').replace(/\s+/g,'_')}.json`);
    }
    function reviewAnswers(){ $('#reviewBox').textContent = buildReportText(); }
    async function copyReport(){
      try{
        await navigator.clipboard.writeText(buildReportText());
        $('#btnCopy').textContent='‚úÖ ’ä’°’ø’≥’•’∂’æ’°’Æ ’ß'; setTimeout(()=>$('#btnCopy').textContent='üìã ’ä’°’ø’≥’•’∂’•’¨',1500);
      }catch(e){ alert('’â’Ω’ø’°÷Å’æ’•÷Å ’∫’°’ø’≥’•’∂’•’¨. ' + e.message); }
    }

    // Reset all persisted (except name is not saved anyway)
    function resetAll(){
      if(!confirm('’Ñ’°÷Ñ÷Ä’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’® ÷á ’Ω’Ø’Ω’•’¨ ’¶÷Ä’∏’µ’´÷Å’û')) return;
      localStorage.removeItem('ff_state');
      location.reload();
    }

    // ===== Boot =====
    (function init(){
      // wire
      $('#btnStart').addEventListener('click', startApp);
      $('#btnReset').addEventListener('click', resetAll);
      $('#btnEditNameMid').addEventListener('click', editNameInline);
      $('#btnCopy').addEventListener('click', copyReport);
      $('#btnApplyFinish').addEventListener('click', applyFinishName);

      // hotkeys
      window.addEventListener('keydown', (e)=>{
        if(!$('#quiz') || $('#quiz').classList.contains('hidden')) return;
        if(['ArrowRight','l','L'].includes(e.key)) { e.preventDefault(); nextFact(); }
        if(['ArrowLeft','h','H'].includes(e.key))  { e.preventDefault(); prevFact(); }
        if(/^[1-5]$/.test(e.key)) { e.preventDefault(); rate(Number(e.key)); }
      });

      // leave warning if mid-quiz
      window.onbeforeunload = function(){
        if(!state.finished && (state.answers||[]).some(Boolean)) return true;
      };

      // Do NOT auto-resume name; always show welcome with empty input
      // But if there is saved progress without a name (e.g., user refreshed mid-quiz),
      // we still respect it AFTER user enters a name again (fresh start per requirement).
      // So by design, welcome is always shown.
    })();

  </script>
</body>
</html>
