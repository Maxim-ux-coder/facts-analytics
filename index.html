<!DOCTYPE html>
<html lang="hy">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ีีฅีฟีกึึึีซึ ีีกีฝีฟีฅึ โ 20 ีฐีกึึีธีพ ีฃีถีกีฐีกีฟีธึีด</title>
  <meta name="theme-color" content="#6c63ff">
  <!-- Favicons -->
  <link rel="icon" href="favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" href="boxk.png" sizes="48x48">
  <style>
    :root{
      --brand:#6c63ff; --brand-2:#584de0; --bg1:#eef5ff; --bg2:#fff7fb; --text:#1b1b1f; --muted:#636a73;
      --ok:#2e7d32; --meh:#f57c00; --bad:#e53935; --card:#fff; --radius:14px; --ring:#cbd5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:500 16px/1.6 "Segoe UI", Roboto, system-ui, -apple-system, Arial;color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    header{background:var(--brand);color:#fff;padding:18px;text-align:center;font-size:20px;position:sticky;top:0;z-index:10}
    .container{max-width:920px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 18px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    h1,h2,h3{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 16px;background:var(--brand);color:#fff;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--brand-2);transform:translateY(-1px)}
    .btn:focus-visible{outline:3px solid var(--ring)}
    .btn.ghost{background:#eef1ff;color:#333}
    .btn.danger{background:var(--bad)}
    .btn.flat{background:#f3f4f7;color:#111}
    input,textarea{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;width:100%}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f0f3ff;border:1px solid #dfe3ff;color:#333;margin-right:6px}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .tile{background:#f8f9ff;border:1px solid #e7ebff;border-radius:12px;padding:10px 12px}
    .progress{height:10px;background:#eef1ff;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#8ea2ff,#6c63ff);transition:width .25s}
    .rate button{margin:6px 6px 0 0;padding:10px 14px;border-radius:10px;border:0;color:#fff;cursor:pointer}
    .good{background:var(--ok)} .meh{background:var(--meh)} .bad{background:var(--bad)}
    kbd{background:#f5f6fb;border:1px solid #e1e5ff;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font:600 12px/1 "Segoe UI", system-ui}
    .footer-note{font-size:13px;color:#7a8291}
  </style>
</head>
<body>
  <header>ีีฅีฟีกึึึีซึ ีีกีฝีฟีฅึ โ 20 ึีกีฝีฟ</header>
  <div class="container" role="main">

    <!-- Welcome: keep name input; start always resets deck -->
    <section id="welcome" class="card" aria-labelledby="wl-title">
      <h2 id="wl-title">ิฒีกึีซ ีฃีกีฌีธึีฝีฟ ๐</h2>
      <p class="muted">ิณึีซึ ึีธ ีกีถีธึีถีจี ีฝีฏีฝีฅีฌีธึ ีฐีกีดีกึึ ิฑีถีธึีถีจ <b>ีิป</b> ีบีกีฐีบีกีถีพีธึีด, ีบีฅีฟึ ีง ีฃึีฅีฌ ีฏึีฏีซีถ, ีฅีฉีฅ ีฉีกึีดีกึีถีฅีฝ ีงีปีจึ</p>
      <div class="row" style="align-items:flex-end">
        <div style="flex:1 1 260px">
          <label for="nameInput" class="muted">ิฑีถีธึีถ</label>
          <input id="nameInput" placeholder="ึึ. ิฑึีดีฅีถ" autocomplete="off" />
        </div>
        <button id="btnStart" class="btn">ีีฏีฝีฅีฌ ๐</button>
        <button id="btnReset" class="btn ghost">ีีกึึีฅีฌ ีฟีพีตีกีฌีถีฅึีจ</button>
      </div>
      <p class="footer-note">Hotkeys: 1โ5 ีฃีถีกีฐีกีฟีธึีด, โ/โ ีกีถึีธึีดึ ิฑีถีธึีถีจ ีฏีกึีธีฒ ีฅีฝ ึีธีญีฅีฌ ีฃีถีกีฐีกีฟีดีกีถ ีชีกีดีกีถีกีฏ ึ ีพีฅึีปีธึีดึ</p>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden" aria-live="polite">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="muted">ิฑีถีธึีถ</div>
            <div class="row">
              <div id="userName" class="pill">ิฑีถีกีถีธึีถ</div>
              <button class="btn flat" id="btnEditNameMid">ีีธีญีฅีฌ ีกีถีธึีถีจ</button>
            </div>
          </div>
          <div class="kpi">
            <div class="tile">ีีธึึีกีคึีพีกีฎี <b id="shown">0/20</b></div>
            <div class="tile">ิฟีกีฟีฅีฃีธึีซีกี <span id="catName">โ</span></div>
          </div>
        </div>
        <div class="progress" aria-label="ิฑีผีกีปีจีถีฉีกึ"><span id="pg"></span></div>
      </div>

      <div class="card">
        <div class="muted" id="factCat">โ</div>
        <h2 id="factText">โ</h2>
        <div class="rate" aria-label="ิณีถีกีฐีกีฟีฅีฌ ึีกีฝีฟีจ">
          <button class="good" onclick="rate(5)">๐ ีีกีฟ ีฝีซึีฅึีซ <kbd>5</kbd></button>
          <button class="good" onclick="rate(4)">๐ ีีฅีฟีกึึึีซึ ีงึ <kbd>4</kbd></button>
          <button class="meh"  onclick="rate(3)">๐ ีีธึีดีกีฌ <kbd>3</kbd></button>
          <button class="bad"  onclick="rate(2)">๐ ีีง <kbd>2</kbd></button>
          <button class="bad"  onclick="rate(1)">๐ซ ิปีถีฑ ีฐีกีดีกึ ีนีง <kbd>1</kbd></button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" onclick="prevFact()">โ ีีกีญีธึีคีจ <kbd>โ</kbd></button>
          <button class="btn" onclick="nextFact()">ีีกีปีธึีคีจ โ <kbd>โ</kbd></button>
        </div>
      </div>
    </section>

    <!-- Finish -->
    <section id="finish" class="hidden">
      <div class="card">
        <h2>ีีถีธึีฐีกีฏีกีฌีธึีฉีตีธึีถ ๐</h2>
        <p class="muted">ิฑีพีกึีฟีฅีฌีธึึ ีกีผีกีป ีฏีกึีธีฒ ีฅีฝ <b>ึีธีญีฅีฌ ีกีถีธึีถีจ</b> ีฐีกีทีพีฅีฟีพีธึีฉีตีกีถ ีฐีกีดีกึ, ีกีพีฅีฌีกึีถีฅีฌ ีกีผีกีปีกึีฏีถีฅึ ึ ีถีฅึีขีฅีผีถีฅีฌ TXT/JSONึ</p>
      </div>

      <div class="card">
        <h3>ิฑีถีธึีถ ีฐีกีทีพีฅีฟีพีธึีฉีตีกีถ ีฐีกีดีกึ</h3>
        <div class="row">
          <input id="nameFinish" placeholder="ึึ. ิฑึีดีฅีถ" />
          <button class="btn flat" id="btnApplyFinish">ิฟีซึีกีผีฅีฌ</button>
        </div>
      </div>

      <div id="suggestions" class="card">
        <h3>ิฑีผีกีปีกึีฏีถีฅึ</h3>
        <div id="suggestList"></div>
        <button class="btn ghost" onclick="addSuggestion()">โ ีีธึ ีกีผีกีปีกึีฏ</button>
      </div>

      <div class="card">
        <h3>ิฑีพีกึีฟีฅีฌ</h3>
        <div class="row">
          <button class="btn" onclick="downloadReport()">โฌ๏ธ TXT</button>
          <button class="btn" onclick="downloadJSON()">โฌ๏ธ JSON</button>
          <button class="btn ghost" onclick="reviewAnswers()">๐ ิดีซีฟีฅีฌ</button>
          <button class="btn flat" id="btnCopy">๐ ีีกีฟีณีฅีถีฅีฌ</button>
        </div>
        <div id="reviewBox" class="muted" style="margin-top:10px;white-space:pre-wrap"></div>
      </div>
    </section>

  </div>

  <script>
    // ===== Helpers =====
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const readLS=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};
    const nowStr=()=>new Date().toLocaleString();

    // Seeded shuffle (LCG)
    function seededShuffle(arr, seedStr){
      let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31 + seedStr.charCodeAt(i))>>>0;
      let a=1664525, c=1013904223, m=2**32, x=seed||123456789;
      const out=arr.slice();
      for(let i=out.length-1;i>0;i--){
        x=(a*x+c)%m; const j = Math.floor((x/m)*(i+1)); [out[i],out[j]]=[out[j],out[i]];
      }
      return out;
    }

    // ===== Data =====
    const CATEGORIES=[
      {id:'science', name:'ิณีซีฟีธึีฉีตีธึีถ'},
      {id:'history', name:'ีีกีฟีดีธึีฉีตีธึีถ'},
      {id:'animals', name:'ิฟีฅีถีคีกีถีซีถีฅึ'},
      {id:'space', name:'ีีซีฅีฆีฅึึ'},
      {id:'tech', name:'ีีฅีญีถีธีฌีธีฃีซีกีถีฅึ'}
    ];

    const FACTS = {
      science: [
        'ีีกึีคีธึ ิดีิน-ีซ ีกีดีขีธีฒีป ีฅึีฏีกึีธึีฉีตีธึีถีจ, ีฅีฉีฅ ีฑีฃีพีฅึ, ีฏีฃีฅึีกีฆีกีถึีฅึ ิฑึีฅีฃีกีฏีซึ ีดีซีถีนึ ีีฌีธึีฟีธีถ ีฐีฅีผีกีพีธึีธึีฉีตีธึีถีจึ',
        'ีึีฟีซ ีขีกีขีกีญีตีธึีถีจ ีฏีกึีธีฒ ีง ึีธีญีฅีฌ ีดีกึีคีธึ ีธึีฒีฅีฒีซ ีกีฌีซึีถีฅึีจ ึ ีกีฆีคีฅึีธึีฉีตีธึีถ ีธึีถีฅีถีกีฌ ีฐีซีทีธีฒีธึีฉีตีกีถ ีพึีกึ',
        'ีีกีฏีฅึีฅีฝีกีตีซีถ ีฌีกึีพีธีฒีธึีฉีตีกีถ ีบีกีฟีณีกีผีธีพ ึีธึึ ีดีซีปีกีฟีถีฅึีจ ีฏีกึีธีฒ ีฅีถ ึีกีตีฌีฅีฌ ีปึีซ ีพึีกึ',
        'ีีกึีคีธึ ีฝีฟีกีดีธึีฝีจ ีตีธึึีกึีกีถีนีตีธึึ ีดีซ ึีกีถีซ ึึ ึีธีญีธึีด ีง ีฌีธึีฑีกีฉีกีฒีกีถีฉีจ, ีธึ ีนีฐีกีฌีนีซ ีฝีฅึีกีฏีกีถ ีฉีฉีพีซึึ',
        'ิฟีฅีถีฝีกีขีกีถีกีฏีกีถ ีฟีฅีฝีกีถีฏีตีธึีถีซึ ีดีกึีคีฏีกีถึ ิดีิน-ีถ 60%-ีธีพ ีถีดีกีถ ีง ีขีกีถีกีถีซ ิดีิน-ีซีถึ'
      ],
      history: [
        'ีีซีถ ิตีฃีซีบีฟีธีฝีธึีด ีกีผีกีปีซีถ ีฐีกีตีฟีถีซ ีบีกีตีดีกีถีกีฃึีฅึีจ ีฏีถึีพีฅีฌ ีฅีถ ีคีฅีผึีฝ ีด.ีฉ.ีก. 3000-ีซีถึ',
        'ิฑีฌีฅึีฝีกีถีคึ ีีกีฏีฅีคีธีถีกึีซีถ ีฐีซีดีถีกีคึีฅีฌ ีง ีกีพีฅีฌีซ ึีกีถ 20 ึีกีฒีกึ ีซึ ีกีถีธึีถีธีพี ิฑีฌีฅึีฝีกีถีคีกีบีธีฌึ',
        'ีีซีถ ีีผีธีดีธึีด ีดีฅีฟีกีฒีกีคึีกีดีถีฅึีธีพ ีกีทีญีกีฟีกีพีกึีฑ ีฝีฟีกึีธีฒ ีฆีซีถีพีธึีถีฅึีซีถ ีกีฝีธึีด ีงีซีถ ยซีฝีกีฌีกึีซีธึีดยป (ีกีฒีซ ีฃีธึีดีกึ)ึ',
        'ีีซีปีถีกีคีกึีธึีด ีฏีกีฟีธึีถีฅึีซีถ ีฅึีขีฅีดีถ ีคีกีฟีธึีด ีงีซีถ ีธึีบีฅีฝ ยซีฐีกีถึีกีฃีธึีฎยปึ',
        'ิฑึีฟีกีทีกีฟีจ ีฐีกีตีฟีถีซ ีงึ ีธึีบีฅีฝ ยซีีกีตีฏีกีฏีกีถ ิฟีกึีฉีกีฃีฅีถยปี ีดีฅีฎ ีกีผึีฟึีกีฏีกีถ ีฏีฅีถีฟึีธีถ ีฌีซีถีฅีฌีธีพึ'
      ],
      animals: [
        'ิฑึีฌีธึีถีฅึีจ ีฏีกึีธีฒ ีฅีถ ีฌีฝีฅีฌ ีดีซีถีนึ 85 ีฏีึ ีขีกึีฑึ ีฐีกีณีกีญีกีฏีกีถีธึีฉีตีกีถ ีฑีกีตีถีฅึ, ีธึีจ ีดีกึีคีซีฏ ีนีฅีถ ีจีถีฏีกีฌีธึีดึ',
        'ิณีถีคีกีฏีกีฑึ ีฑีฏีถีซีฏีถีฅึีจ ีธึีถีฅีถ ีฉีธึีตีถ, ีธึีถ ีกีพีฅีฌีซ ีดีกีฐีกึีธึ ีง, ึีกีถ ึีซีกีถีซีคีจึ',
        'ีีซีฒีจ ีดีซีกีฏ ีฏีฅีถีคีกีถีซีถ ีง, ีธึีจ ีนีซ ีฏีกึีธีฒ ึีกีฟีฏีฅีฌึ',
        'ีีซีถีฃีพีซีถีถีฅึีซ ีฆีธึีตีฃีฅึีจ ีฐีกีณีกีญ ีฃีฟีถีธึีด ีฅีถ ีซึีกึ ีฐีกีฟีธึีฏ ยซีฝีซึีธ ีฏีกีถีนีธีพยปึ',
        'ิฟีกึีดีซึ ีบีกีถีคีกีถ ีซึีกีฏีกีถีธึีด ีกีพีฅีฌีซ ีดีธีฟ ีง ีงีถีคีฅีดีซีฏ ีฏีฅีถีคีกีถีซีถีฅึีซีถ, ึีกีถ ีดีฅีฎ ีบีกีถีคีกีถีฅึีซีถึ'
      ],
      space: [
        'ิฑึีฅีฃีกีฏีถ ีตีธึึีกึีกีถีนีตีธึึ ีพีกีตึีฏีตีกีถีธึีด ึีธีญีกึีฏีธึีด ีง ีดีธีฟ 600 ีดีซีฌีซีธีถ ีฟีธีถีถีก ีฐีฅีฌีซีธึีดีซ ีปึีกีฎีซีถึ',
        'ีีกีฟีธึึีถีซ ึีฒีกีฏีถีฅึีจ ีขีกีฒีฏีกึีกีฎ ีฅีถ ีฐีซีดีถีกีฏีกีถีธึีด ีฝีกีผีธึีตึีซึ ึ ึีธีทีธึึึ',
        'ีีซีปีกีฆีฃีกีตีซีถ ีฟีซีฅีฆีฅึีกีฏีกีตีกีถีซ ีกึีกีฃีธึีฉีตีธึีถีจ ีดีธีฟ 28 000 ีฏีด/ีช ีงึ',
        'ีีธึีบีซีฟีฅึีซ ีีฅีฎ ิฟีกึีดีซึ ิฟีฅีฟีจ ึีธีฉีธึีซีฏ ีง, ีธึีจ ีฃีธีตีธึีฉีตีธึีถ ีธึีถีซ ีกีผีถีพีกีฆีถ 350 ีฟีกึีซึ',
        'ีีซีฅีฆีฅึึีธึีด ีฌีกึ ีฌีซีถีฅีฌีธึ ีคีฅีบึีธึีด ีกึึีธึีถึีถีฅึีจ ีนีฅีถ ีฐีธีฝีธึีด, ีกีตีฌ ีดีถีธึีด ีฅีถ ีกีนึีฅึีซ ีพึีก ีธึีบีฅีฝ ีฃีถีคีซีฏีถีฅึึ'
      ],
      tech: [
        'ิฑีผีกีปีซีถ ีฐีกีดีกีฏีกึีฃีนีกีตีซีถ ีดีฏีถีซีฏีจ ีบีกีฟึีกีฝีฟีพีกีฎ ีงึ ึีกีตีฟีซึ (1964ีฉ.)ึ',
        'Google ีกีถีธึีถีจ ีฃีกีฌีซีฝ ีง ยซgoogolยป ีขีกีผีซึี ีฏีกีดีพีกีฎ 1-ีซึ ึ 100 ีฆึีธีตีซึึ',
        'ิฑีผีกีปีซีถ ีฏีธีทีฟ ีฝีฏีกีพีกีผีกีฏีจ ีฏีทีผีธึีด ีงึ ีกีพีฅีฌีซ ึีกีถ ีดีฅีฏ ีฟีธีถีถีก ึ ีบีกีฐีธึีด ีงึ ีจีถีคีกีดีฅีถีจ 5 ีิฒ ีฟีพีตีกีฌึ',
        'Bluetooth ีกีถีธึีถีจ ีพีฅึึีพีกีฎ ีง ีฝีฏีกีถีคีซีถีกีพีตีกีถ ีฉีกีฃีกีพีธึีซึี ีีกึีกีฌีค ิฟีกีบีฟีกีถีกีฟีกีญีฟีกีฏีซึึ',
        'ิฑีผีกีปีซีถ iPhone-ีจ ีนีงึ ีกีปีกีฏึีธึีด ยซcopy-pasteยป ึีธึีถีฏึีซีกีถึ'
      ]
    };

    // ===== State (name is NOT persisted) =====
    const EMPTY = ()=>({
      name: '', deck: [], idx: 0, answers: [], suggestions: [''], finished:false
    });

    let state = readLS('ff_state') || EMPTY();
    // Drop any persisted name to follow the rule
    state.name = '';

    function persist(){
      // Save everything EXCEPT name
      const copy = {...state, name:''};
      saveLS('ff_state', copy);
    }

    // ===== Deck generation (20 = 5ร4) =====
    function buildDeck(){
      const nm = state.name || 'guest';
      const cats=CATEGORIES.map(c=>c.id);
      const deck=[];
      for(const cat of cats){
        const pool = FACTS[cat].slice();
        const shuffled = seededShuffle(pool, nm);
        const take4 = shuffled.slice(0,4);
        for(let i=0;i<take4.length;i++){
          deck.push({ id:`${cat}_${i}`, cat, text: take4[i] });
        }
      }
      state.deck = seededShuffle(deck, nm);
      state.idx = 0; state.answers = []; state.finished=false;
      persist();
    }

    // ===== UI flow =====
    function startApp(){
      const nm = ($('#nameInput').value||'').trim();
      if(!nm){ alert('ิณึีซีึ ีกีถีธึีถีจ โ๏ธ'); return; }
      // ALWAYS start fresh after submitting the name
      state = EMPTY();
      state.name = nm;
      buildDeck();
      $('#userName').textContent = nm;
      $('#shown').textContent = '0/20';
      $('#welcome').classList.add('hidden');
      $('#quiz').classList.remove('hidden');
      updateProgress();
      showCurrent();
      persist();
    }

    function editNameInline(){
      const nm = prompt('ีีธึ ีกีถีธึีถีจ', state.name||'');
      if(nm===null) return;
      const newName = nm.trim();
      if(!newName){ alert('ิฑีถีธึีถีจ ีนีซ ีฏีกึีธีฒ ีฌีซีถีฅีฌ ีคีกีฟีกึีฏึ'); return; }
      const keepRatings = confirm('ีีกีฐีฅีีฌ ีจีถีฉีกึีซีฏ ีฃีถีกีฐีกีฟีกีฏีกีถีถีฅึีจ (re-seed ีจีฝีฟ ีถีธึ ีกีถีธึีถีซ)ึ OKี ีบีกีฐีฅีฌ, Cancelี ีฝีฏีฝีฅีฌ ีฆึีธีตีซึึ');
      state.name = newName;
      if(keepRatings){
        const oldAnswers = state.answers.slice();
        buildDeck();
        const map = new Map(oldAnswers.filter(Boolean).map(a=>[a.text,a.rating]));
        state.answers = state.deck.map(it => map.has(it.text) ? {...it, rating: map.get(it.text)} : undefined);
      }else{
        buildDeck();
      }
      $('#userName').textContent = state.name;
      updateProgress();
      showCurrent();
      persist();
    }

    function applyFinishName(){
      const nm = ($('#nameFinish').value||'').trim();
      if(!nm){ alert('ิณึีซีึ ีกีถีธึีถีจ ีฐีกีทีพีฅีฟีพีธึีฉีตีกีถ ีฐีกีดีกึ'); return; }
      state.name = nm; // still not persisted
      $('#userName').textContent = nm;
      reviewAnswers();
    }

    function showCurrent(){
      if(state.idx >= state.deck.length){ finishFlow(); return; }
      const item = state.deck[state.idx];
      const catName = CATEGORIES.find(c=>c.id===item.cat).name;
      $('#catName').textContent = catName;
      $('#factCat').textContent = catName;
      $('#factText').textContent = item.text;
      $('#shown').textContent = `${Math.min(state.idx+1,20)}/20`;
      updateProgress();
    }

    function updateProgress(){
      const done = state.answers.filter(a=>a && a.rating>0).length;
      const pct = Math.round((done/20)*100);
      $('#pg').style.width = pct+'%';
    }

    function nextFact(){
      if(state.idx < state.deck.length-1){ state.idx++; showCurrent(); persist(); }
      else { finishFlow(); }
    }
    function prevFact(){
      if(state.idx>0){ state.idx--; showCurrent(); persist(); }
    }

    function rate(q){
      const item = state.deck[state.idx];
      state.answers[state.idx] = { ...item, rating:q };
      persist();
      nextFact();
    }

    function finishFlow(){
      state.finished=true; persist();
      $('#quiz').classList.add('hidden');
      $('#finish').classList.remove('hidden');
      if(!state.suggestions || !state.suggestions.length) state.suggestions=[''];
      // prefill finish name with current (not persisted)
      $('#nameFinish').value = state.name || '';
      renderSuggestions();
      reviewAnswers();
      window.onbeforeunload = null;
    }

    // ===== Suggestions =====
    function renderSuggestions(){
      const box = $('#suggestList'); box.innerHTML='';
      state.suggestions.forEach((val, i)=>{
        const wrap=document.createElement('div'); wrap.className='row'; wrap.style.margin='8px 0';
        const label=document.createElement('div'); label.textContent=`ิฑีผีกีปีกึีฏ ${i+1}`; label.style.minWidth='110px'; label.className='muted';
        const input=document.createElement('input'); input.value=val; input.placeholder='ีีฅึ ีกีผีกีปีกึีฏีจโฆ';
        input.oninput=()=>{ state.suggestions[i]=input.value; persist(); };
        const rm=document.createElement('button'); rm.className='btn danger'; rm.textContent='โ';
        rm.onclick=()=>{ state.suggestions.splice(i,1); renderSuggestions(); persist(); };
        wrap.appendChild(label); wrap.appendChild(input); wrap.appendChild(rm);
        box.appendChild(wrap);
      });
    }
    function addSuggestion(){ state.suggestions.push(''); renderSuggestions(); persist(); }

    // ===== Report =====
    function catMap(){ const m={}; for(const c of CATEGORIES){ m[c.id]={name:c.name,sum:0,n:0}; } return m; }

    function buildReportText(){
      const lines=[]; const now=nowStr();
      lines.push(`ิฑีถีธึีถ: ${state.name || 'ิฑีถีกีถีธึีถ'}`);
      lines.push(`ิฑีดีฝีกีฉีซีพ/ีชีกีด: ${now}`);
      lines.push('');
      const perCat=catMap();
      state.answers.forEach(a=>{ if(!a) return; perCat[a.cat].sum+=a.rating||0; perCat[a.cat].n++; });
      lines.push('ิฟีกีฟีฅีฃีธึีซีกีถีฅึีซ ีกีดึีธึีธึีด:');
      let bestCat=null, bestAvg=-1;
      for(const cid of Object.keys(perCat)){
        const {name,sum,n}=perCat[cid]; const avg = n? (sum/n).toFixed(2) : 'โ';
        lines.push(`- ${name}: ีดีซีปีซีถ ${avg} (${n} ึีกีฝีฟ)`);
        if(n){ const v=sum/n; if(v>bestAvg){ bestAvg=v; bestCat=name; } }
      }
      lines.push(`ิผีกีพีกีฃีธึีตีถ ีฏีกีฟีฅีฃีธึีซีก: ${bestCat||'โ'}`);
      lines.push('');
      lines.push('ีีกีถึีกีดีกีฝีถีธึีฉีตีธึีถีถีฅึ (20 ึีกีฝีฟ) โ ีฏีกึีฃีธีพ:');
      state.deck.forEach((it, i)=>{
        const a = state.answers[i];
        const catName = CATEGORIES.find(c=>c.id===it.cat).name;
        const r = a? a.rating : 'โ';
        lines.push(`${String(i+1).padStart(2,'0')}. [${catName}] ${it.text} => ิณีถีกีฐีกีฟีกีฏีกีถ: ${r}`);
      });
      lines.push('');
      lines.push('ิฑีผีกีปีกึีฏีถีฅึ:');
      const nonEmpty=(state.suggestions||[]).map(s=>s.trim()).filter(Boolean);
      if(nonEmpty.length){ nonEmpty.forEach((s,i)=> lines.push(`- ${i+1}) ${s}`)); }
      else { lines.push('โ'); }
      return lines.join('\n');
    }

    function buildReportJSON(){
      const perCat=catMap();
      state.answers.forEach(a=>{ if(!a) return; perCat[a.cat].sum+=a.rating||0; perCat[a.cat].n++; });
      const stats = Object.entries(perCat).map(([cid,{name,sum,n}])=>({id:cid,name,avg:n?sum/n:null,count:n}));
      const best = stats.filter(s=>s.count>0).sort((a,b)=>b.avg-a.avg)[0]?.name || null;
      return {
        name: state.name || null,
        timestamp: new Date().toISOString(),
        deck: state.deck,
        answers: state.answers,
        suggestions: (state.suggestions||[]).filter(s=>s && s.trim()),
        stats: { perCategory: stats, bestCategory: best }
      };
    }

    function download(blob, filename){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }
    function downloadReport(){
      const txt = buildReportText();
      download(new Blob([txt], {type:'text/plain;charset=utf-8'}), `facts_report_${(state.name||'user').replace(/\s+/g,'_')}.txt`);
    }
    function downloadJSON(){
      const json = JSON.stringify(buildReportJSON(), null, 2);
      download(new Blob([json], {type:'application/json'}), `facts_report_${(state.name||'user').replace(/\s+/g,'_')}.json`);
    }
    function reviewAnswers(){ $('#reviewBox').textContent = buildReportText(); }
    async function copyReport(){
      try{
        await navigator.clipboard.writeText(buildReportText());
        $('#btnCopy').textContent='โ ีีกีฟีณีฅีถีพีกีฎ ีง'; setTimeout(()=>$('#btnCopy').textContent='๐ ีีกีฟีณีฅีถีฅีฌ',1500);
      }catch(e){ alert('ีีฝีฟีกึีพีฅึ ีบีกีฟีณีฅีถีฅีฌ. ' + e.message); }
    }

    // Reset all persisted (except name is not saved anyway)
    function resetAll(){
      if(!confirm('ีีกึึีฅีฌ ีฟีพีตีกีฌีถีฅึีจ ึ ีฝีฏีฝีฅีฌ ีฆึีธีตีซึี')) return;
      localStorage.removeItem('ff_state');
      location.reload();
    }

    // ===== Boot =====
    (function init(){
      // wire
      $('#btnStart').addEventListener('click', startApp);
      $('#btnReset').addEventListener('click', resetAll);
      $('#btnEditNameMid').addEventListener('click', editNameInline);
      $('#btnCopy').addEventListener('click', copyReport);
      $('#btnApplyFinish').addEventListener('click', applyFinishName);

      // hotkeys
      window.addEventListener('keydown', (e)=>{
        if(!$('#quiz') || $('#quiz').classList.contains('hidden')) return;
        if(['ArrowRight','l','L'].includes(e.key)) { e.preventDefault(); nextFact(); }
        if(['ArrowLeft','h','H'].includes(e.key))  { e.preventDefault(); prevFact(); }
        if(/^[1-5]$/.test(e.key)) { e.preventDefault(); rate(Number(e.key)); }
      });

      // leave warning if mid-quiz
      window.onbeforeunload = function(){
        if(!state.finished && (state.answers||[]).some(Boolean)) return true;
      };

      // Do NOT auto-resume name; always show welcome with empty input
      // But if there is saved progress without a name (e.g., user refreshed mid-quiz),
      // we still respect it AFTER user enters a name again (fresh start per requirement).
      // So by design, welcome is always shown.
    })();

  </script>
</body>
</html>
