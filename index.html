<!DOCTYPE html>
<html lang="hy">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> ’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ì’°’Ω’ø’•÷Ä ‚Äî 20 ’∞’°÷Ä÷Å’∏’æ ’£’∂’°’∞’°’ø’∏÷Ç’¥</title>
  <style>
    :root{
      --brand:#6c63ff; --brand-2:#584de0; --bg1:#eef5ff; --bg2:#fff7fb; --text:#222; --muted:#666;
      --ok:#2e7d32; --meh:#f57c00; --bad:#e53935; --card:#fff; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:500 16px/1.6 "Segoe UI", Roboto, system-ui, -apple-system, Arial; color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));}
    header{background:var(--brand);color:#fff;padding:18px;text-align:center;font-size:20px}
    .container{max-width:900px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 18px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    h2,h3{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 16px;background:var(--brand);color:#fff;cursor:pointer}
    .btn:hover{background:var(--brand-2)}
    .btn.ghost{background:#eef1ff;color:#333}
    .btn.danger{background:var(--bad)}
    input,textarea{padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;width:100%}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .rate button{margin:6px 6px 0 0;padding:10px 14px;border-radius:10px;border:0;color:#fff;cursor:pointer}
    .good{background:var(--ok)} .meh{background:var(--meh)} .bad{background:var(--bad)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f0f3ff;border:1px solid #dfe3ff;color:#333;margin-right:6px}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .tile{background:#f8f9ff;border:1px solid #e7ebff;border-radius:12px;padding:10px 12px}
    details.tests summary{cursor:pointer}
    code.inline{background:#f4f6ff;border:1px solid #e4e8ff;border-radius:8px;padding:1px 6px}
  </style>
</head>
<body>
  <header> ’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ì’°’Ω’ø’•÷Ä ‚Äî 20 ÷É’°’Ω’ø</header>
  <div class="container">
    <!-- Onboarding -->
    <section id="welcome" class="card">
      <h2>‘≤’°÷Ä’´ ’£’°’¨’∏÷Ç’Ω’ø üëã</h2>
      <p class="muted">‘≥÷Ä’´÷Ä ÷Ñ’∏ ’°’∂’∏÷Ç’∂’®’ù ’Ω’Ø’Ω’•’¨’∏÷Ç ’∞’°’¥’°÷Ä÷â ‘±’∂’∏÷Ç’∂’® ’∫’°’∞’æ’∏÷Ç’¥ ’ß ’¥’´’°’µ’∂ ’°’µ’Ω ’¢÷Ä’°’∏÷Ç’¶’•÷Ä’´ <code class="inline">localStorage</code>-’∏÷Ç’¥÷â</p>
      <div class="row">
        <input id="nameInput" placeholder="÷Ö÷Ä. ‘±÷Ä’¥’•’∂" />
        <button id="btnStart" class="btn" onclick="startApp()">’ç’Ø’Ω’•’¨ üöÄ</button>
        <button id="btnReset" class="btn ghost" onclick="resetAll()">’Ñ’°÷Ñ÷Ä’•’¨ ’ø’æ’µ’°’¨’∂’•÷Ä’®</button>
      </div>
      
    </section>

    <!-- Quiz / Rating -->
    <section id="quiz" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="muted">’Å’•÷Ä ’°’∂’∏÷Ç’∂’®</div>
            <div id="userName" class="pill">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="tile">’ë’∏÷Ç÷Å’°’§÷Ä’æ’°’Æ’ù <b id="shown">0</b></div>
            <div class="tile">‘ø’°’ø’•’£’∏÷Ä’´’°’ù <span id="catName">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted" id="factCat">‚Äî</div>
        <h2 id="factText">‚Äî</h2>
        <div class="rate">
          <button class="good" onclick="rate(5)">üòç ’á’°’ø ’Ω’´÷Ä’•÷Å’´</button>
          <button class="good" onclick="rate(4)">üëç ’Ä’•’ø’°÷Ñ÷Ä÷Ñ’´÷Ä ’ß÷Ä</button>
          <button class="meh"  onclick="rate(3)">üòê ’Ü’∏÷Ä’¥’°’¨</button>
          <button class="bad"  onclick="rate(2)">üëé ’â’ß</button>
          <button class="bad"  onclick="rate(1)">üö´ ‘ª’∂’± ’∞’°’¥’°÷Ä ’π’ß</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" onclick="prevFact()">‚Üê ’Ü’°’≠’∏÷Ä’§’®</button>
          <button class="btn" onclick="nextFact()">’Ä’°’ª’∏÷Ä’§’® ‚Üí</button>
        </div>
      </div>
    </section>

    <!-- Finish / Suggestions -->
    <section id="finish" class="hidden">
      <div class="card">
        <h2>’á’∂’∏÷Ä’∞’°’Ø’°’¨’∏÷Ç’©’µ’∏÷Ç’∂ ’´’∂’± ÷Ö’£’∂’•’¨’∏÷Ç ’∞’°’¥’°÷Ä üôå</h2>
        <p class="muted">‘µ’©’• ÷Å’°’∂’Ø’°’∂’∏÷Ç’¥ ’•÷Ñ ’´’∂’π‚Äë’∏÷Ä ’¢’°’∂ ’°’æ’•’¨’°÷Å’∂’•’¨, ’¨÷Ä’°÷Å÷Ä’•÷Ñ ’°’º’°’ª’°÷Ä’Ø’∂’•÷Ä’´ ’§’°’∑’ø’•÷Ä’®÷â ‘ø’°÷Ä’∏’≤ ’•÷Ñ ’°’æ’•’¨’°÷Å’∂’•’¨ ’°’∂’æ’•÷Ä’ª ’§’°’∑’ø’•÷Ä ¬´’Ü’∏÷Ä ’°’º’°’ª’°÷Ä’Ø¬ª ’Ø’∏’≥’°’Ø’∏’æ÷â ‘ª ’æ’•÷Ä’ª’∏ ’Ω’•’≤’¥’•÷Ñ ¬´’ä’°’ø÷Ä’°’Ω’ø ’ß¬ª’ù ’Ω’ø’°’∂’°’¨’∏÷Ç TXT ÷Ü’°’µ’¨’® ’∂’•÷Ä’¢’•’º’∂’¥’°’∂ ’∞’°’¥’°÷Ä÷â</p>
      </div>
      <div id="suggestions" class="card">
        <h3>‘±’º’°’ª’°÷Ä’Ø’∂’•÷Ä</h3>
        <div id="suggestList"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" onclick="addSuggestion()">‚ûï ’Ü’∏÷Ä ’°’º’°’ª’°÷Ä’Ø</button>
        </div>
      </div>
      <div class="card">
        <h3>‘±’æ’°÷Ä’ø’•’¨</h3>
        <div class="row">
          <button class="btn" onclick="downloadReport()">‚¨áÔ∏è ’ä’°’ø÷Ä’°’Ω’ø ’ß ‚Äî ’∂’•÷Ä’¢’•’º’∂’•’¨ TXT</button>
          <button class="btn ghost" onclick="reviewAnswers()">üìÑ ‘¥’´’ø’•’¨ ’£’∂’°’∞’°’ø’°’Ø’°’∂’∂’•÷Ä’®</button>
        </div>
        <div id="reviewBox" class="muted" style="margin-top:10px;white-space:pre-wrap"></div>
      </div>
    </section>

  <script>
    // ============== Helpers ==============
    const $ = (s)=>document.querySelector(s);
    const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const readLS=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};

    // Deterministic-ish shuffle seeded by name (simple LCG)
    function seededShuffle(arr, seedStr){
      let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31 + seedStr.charCodeAt(i))>>>0;
      let a=1664525, c=1013904223, m=2**32, x=seed||123456789;
      const out=arr.slice();
      for(let i=out.length-1;i>0;i--){ x=(a*x+c)%m; const j = Math.floor((x/m)*(i+1)); [out[i],out[j]]=[out[j],out[i]]; }
      return out;
    }

    // ============== Data (5 categories, >=4 facts each) ==============
    const CATEGORIES=[
      {id:'science', name:'‘≥’´’ø’∏÷Ç’©’µ’∏÷Ç’∂'},
      {id:'history', name:'’ä’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂'},
      {id:'animals', name:'‘ø’•’∂’§’°’∂’´’∂’•÷Ä'},
      {id:'space', name:'’è’´’•’¶’•÷Ä÷Ñ'},
      {id:'tech', name:'’è’•’≠’∂’∏’¨’∏’£’´’°’∂’•÷Ä'}
    ];

      const FACTS = {
    science: [
      '’Ñ’°÷Ä’§’∏÷Ç ‘¥’Ü‘π-’´ ’°’¥’¢’∏’≤’ª ’•÷Ä’Ø’°÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®, ’•’©’• ’±’£’æ’•÷Ä, ’Ø’£’•÷Ä’°’¶’°’∂÷Å’•÷Ä ‘±÷Ä’•’£’°’Ø’´÷Å ’¥’´’∂’π÷á ’ä’¨’∏÷Ç’ø’∏’∂ ’∞’•’º’°’æ’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®÷â',
      '’ç÷Ä’ø’´ ’¢’°’¢’°’≠’µ’∏÷Ç’∂’® ’Ø’°÷Ä’∏’≤ ’ß ÷É’∏’≠’•’¨ ’¥’°÷Ä’§’∏÷Ç ’∏÷Ç’≤’•’≤’´ ’°’¨’´÷Ñ’∂’•÷Ä’® ÷á ’°’¶’§’•÷Å’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’•’∂’°’¨ ’∞’´’∑’∏’≤’∏÷Ç’©’µ’°’∂ ’æ÷Ä’°÷â',
      '’Ñ’°’Ø’•÷Ä’•’Ω’°’µ’´’∂ ’¨’°÷Ä’æ’∏’≤’∏÷Ç’©’µ’°’∂ ’∫’°’ø’≥’°’º’∏’æ ÷É’∏÷Ñ÷Ä ’¥’´’ª’°’ø’∂’•÷Ä’® ’Ø’°÷Ä’∏’≤ ’•’∂ ÷Ñ’°’µ’¨’•’¨ ’ª÷Ä’´ ’æ÷Ä’°÷â',
      '’Ñ’°÷Ä’§’∏÷Ç ’Ω’ø’°’¥’∏÷Ñ’Ω’® ’µ’∏÷Ç÷Ä’°÷Ñ’°’∂’π’µ’∏÷Ç÷Ä ’¥’´ ÷Ñ’°’∂’´ ÷Ö÷Ä ÷É’∏’≠’∏÷Ç’¥ ’ß ’¨’∏÷Ä’±’°’©’°’≤’°’∂’©’®, ’∏÷Ä ’π’∞’°’¨’π’´ ’Ω’•÷É’°’Ø’°’∂ ’©’©’æ’´÷Å÷â',
      '‘ø’•’∂’Ω’°’¢’°’∂’°’Ø’°’∂ ’ø’•’Ω’°’∂’Ø’µ’∏÷Ç’∂’´÷Å ’¥’°÷Ä’§’Ø’°’∂÷Å ‘¥’Ü‘π-’∂ 60%-’∏’æ ’∂’¥’°’∂ ’ß ’¢’°’∂’°’∂’´ ‘¥’Ü‘π-’´’∂÷â'
    ],
    history: [
      '’Ä’´’∂ ‘µ’£’´’∫’ø’∏’Ω’∏÷Ç’¥ ’°’º’°’ª’´’∂ ’∞’°’µ’ø’∂’´ ’∫’°’µ’¥’°’∂’°’£÷Ä’•÷Ä’® ’Ø’∂÷Ñ’æ’•’¨ ’•’∂ ’§’•’º÷á’Ω ’¥.’©.’°. 3000-’´’∂÷â',
      '‘±’¨’•÷Ñ’Ω’°’∂’§÷Ä ’Ñ’°’Ø’•’§’∏’∂’°÷Å’´’∂ ’∞’´’¥’∂’°’§÷Ä’•’¨ ’ß ’°’æ’•’¨’´ ÷Ñ’°’∂ 20 ÷Ñ’°’≤’°÷Ñ ’´÷Ä ’°’∂’∏÷Ç’∂’∏’æ’ù ‘±’¨’•÷Ñ’Ω’°’∂’§’°’∫’∏’¨÷â',
      '’Ä’´’∂ ’Ä’º’∏’¥’∏÷Ç’¥ ’¥’•’ø’°’≤’°’§÷Ä’°’¥’∂’•÷Ä’∏’æ ’°’∑’≠’°’ø’°’æ’°÷Ä’± ’Ω’ø’°÷Å’∏’≤ ’¶’´’∂’æ’∏÷Ä’∂’•÷Ä’´’∂ ’°’Ω’∏÷Ç’¥ ’ß’´’∂ ¬´’Ω’°’¨’°÷Ä’´’∏÷Ç’¥¬ª (’°’≤’´ ’£’∏÷Ç’¥’°÷Ä)÷â',
      '’Ñ’´’ª’∂’°’§’°÷Ä’∏÷Ç’¥ ’Ø’°’ø’∏÷Ç’∂’•÷Ä’´’∂ ’•÷Ä’¢’•’¥’∂ ’§’°’ø’∏÷Ç’¥ ’ß’´’∂ ’∏÷Ä’∫’•’Ω ¬´’∞’°’∂÷Å’°’£’∏÷Ä’Æ¬ª÷â',
      '‘±÷Ä’ø’°’∑’°’ø’® ’∞’°’µ’ø’∂’´ ’ß÷Ä ’∏÷Ä’∫’•’Ω ¬´’Ä’°’µ’Ø’°’Ø’°’∂ ‘ø’°÷Ä’©’°’£’•’∂¬ª’ù ’¥’•’Æ ’°’º÷á’ø÷Ä’°’Ø’°’∂ ’Ø’•’∂’ø÷Ä’∏’∂ ’¨’´’∂’•’¨’∏’æ÷â'
    ],
    animals: [
      '‘±÷Ñ’¨’∏÷Ä’∂’•÷Ä’® ’Ø’°÷Ä’∏’≤ ’•’∂ ’¨’Ω’•’¨ ’¥’´’∂’π÷á 85 ’Ø’Ä÷Å ’¢’°÷Ä’±÷Ä ’∞’°’≥’°’≠’°’Ø’°’∂’∏÷Ç’©’µ’°’∂ ’±’°’µ’∂’•÷Ä, ’∏÷Ä’® ’¥’°÷Ä’§’´’Ø ’π’•’∂ ’®’∂’Ø’°’¨’∏÷Ç’¥÷â',
      '‘≥’∂’§’°’Ø’°’±÷á ’±’Ø’∂’´’Ø’∂’•÷Ä’® ’∏÷Ç’∂’•’∂ ’©’∏÷Ç’µ’∂, ’∏÷Ä’∂ ’°’æ’•’¨’´ ’¥’°’∞’°÷Å’∏÷Ç ’ß, ÷Ñ’°’∂ ÷Å’´’°’∂’´’§’®÷â',
      '’ì’´’≤’® ’¥’´’°’Ø ’Ø’•’∂’§’°’∂’´’∂ ’ß, ’∏÷Ä’® ’π’´ ’Ø’°÷Ä’∏’≤ ÷Å’°’ø’Ø’•’¨÷â',
      '’ä’´’∂’£’æ’´’∂’∂’•÷Ä’´ ’¶’∏÷Ç’µ’£’•÷Ä’® ’∞’°’≥’°’≠ ’£’ø’∂’∏÷Ç’¥ ’•’∂ ’´÷Ä’°÷Ä ’∞’°’ø’∏÷Ç’Ø ¬´’Ω’´÷Ä’∏ ’Ø’°’∂’π’∏’æ¬ª÷â',
      '‘ø’°÷Ä’¥’´÷Ä ’∫’°’∂’§’°’∂ ’´÷Ä’°’Ø’°’∂’∏÷Ç’¥ ’°’æ’•’¨’´ ’¥’∏’ø ’ß ’ß’∂’§’•’¥’´’Ø ’Ø’•’∂’§’°’∂’´’∂’•÷Ä’´’∂, ÷Ñ’°’∂ ’¥’•’Æ ’∫’°’∂’§’°’∂’•÷Ä’´’∂÷â'
    ],
    space: [
      '‘±÷Ä’•’£’°’Ø’∂ ’µ’∏÷Ç÷Ä’°÷Ñ’°’∂’π’µ’∏÷Ç÷Ä ’æ’°’µ÷Ä’Ø’µ’°’∂’∏÷Ç’¥ ÷É’∏’≠’°÷Ä’Ø’∏÷Ç’¥ ’ß ’¥’∏’ø 600 ’¥’´’¨’´’∏’∂ ’ø’∏’∂’∂’° ’∞’•’¨’´’∏÷Ç’¥’´ ’ª÷Ä’°’Æ’´’∂÷â',
      '’ç’°’ø’∏÷Ç÷Ä’∂’´ ÷Ö’≤’°’Ø’∂’•÷Ä’® ’¢’°’≤’Ø’°÷Å’°’Æ ’•’∂ ’∞’´’¥’∂’°’Ø’°’∂’∏÷Ç’¥ ’Ω’°’º’∏÷Ç’µ÷Å’´÷Å ÷á ÷É’∏’∑’∏÷Ç÷Å÷â',
      '’Ñ’´’ª’°’¶’£’°’µ’´’∂ ’ø’´’•’¶’•÷Ä’°’Ø’°’µ’°’∂’´ ’°÷Ä’°’£’∏÷Ç’©’µ’∏÷Ç’∂’® ’¥’∏’ø 28 000 ’Ø’¥/’™ ’ß÷â',
      '’Ö’∏÷Ç’∫’´’ø’•÷Ä’´ ’Ñ’•’Æ ‘ø’°÷Ä’¥’´÷Ä ‘ø’•’ø’® ÷É’∏’©’∏÷Ä’´’Ø ’ß, ’∏÷Ä’® ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´ ’°’º’∂’æ’°’¶’∂ 350 ’ø’°÷Ä’´÷â',
      '’è’´’•’¶’•÷Ä÷Ñ’∏÷Ç’¥ ’¨’°÷Å ’¨’´’∂’•’¨’∏÷Ç ’§’•’∫÷Ñ’∏÷Ç’¥ ’°÷Ä÷Å’∏÷Ç’∂÷Ñ’∂’•÷Ä’® ’π’•’∂ ’∞’∏’Ω’∏÷Ç’¥, ’°’µ’¨ ’¥’∂’∏÷Ç’¥ ’•’∂ ’°’π÷Ñ’•÷Ä’´ ’æ÷Ä’° ’∏÷Ä’∫’•’Ω ’£’∂’§’´’Ø’∂’•÷Ä÷â'
    ],
    tech: [
      '‘±’º’°’ª’´’∂ ’∞’°’¥’°’Ø’°÷Ä’£’π’°’µ’´’∂ ’¥’Ø’∂’´’Ø’® ’∫’°’ø÷Ä’°’Ω’ø’æ’°’Æ ’ß÷Ä ÷É’°’µ’ø’´÷Å (1964’©.)÷â',
      'Google ’°’∂’∏÷Ç’∂’® ’£’°’¨’´’Ω ’ß ¬´googol¬ª ’¢’°’º’´÷Å’ù ’Ø’°’¥’æ’°’Æ 1-’´÷Å ÷á 100 ’¶÷Ä’∏’µ’´÷Å÷â',
      '‘±’º’°’ª’´’∂ ’Ø’∏’∑’ø ’Ω’Ø’°’æ’°’º’°’Ø’® ’Ø’∑’º’∏÷Ç’¥ ’ß÷Ä ’°’æ’•’¨’´ ÷Ñ’°’∂ ’¥’•’Ø ’ø’∏’∂’∂’° ÷á ’∫’°’∞’∏÷Ç’¥ ’ß÷Ä ’®’∂’§’°’¥’•’∂’® 5 ’Ñ‘≤ ’ø’æ’µ’°’¨÷â',
      'Bluetooth ’°’∂’∏÷Ç’∂’® ’æ’•÷Ä÷Å’æ’°’Æ ’ß ’Ω’Ø’°’∂’§’´’∂’°’æ’µ’°’∂ ’©’°’£’°’æ’∏÷Ä’´÷Å’ù ’Ä’°÷Ä’°’¨’§ ‘ø’°’∫’ø’°’∂’°’ø’°’≠’ø’°’Ø’´÷Å÷â',
      '‘±’º’°’ª’´’∂ iPhone-’® ’π’ß÷Ä ’°’ª’°’Ø÷Å’∏÷Ç’¥ ¬´copy-paste¬ª ÷Ü’∏÷Ç’∂’Ø÷Å’´’°’∂÷â'
    ]
  };


    // ============== State ==============
    let state = {
      name: readLS('ff_name') || '',
      deck: [], // 20 items: {id, cat, text}
      idx: 0,
      answers: [], // {id, cat, text, rating}
      suggestions: ['']
    };

    // ============== Deck generation (20 = 5 cats √ó 4) ==============
    function buildDeck(){
      const cats=CATEGORIES.map(c=>c.id); // 5
      const deck=[];
      for(const cat of cats){
        const pool = FACTS[cat].slice();
        const shuffled = seededShuffle(pool, state.name||'guest');
        const take4 = shuffled.slice(0,4);
        for(let i=0;i<take4.length;i++){
          deck.push({ id:`${cat}_${i}`, cat, text: take4[i] });
        }
      }
      // Mix final deck to interleave categories nicely
      state.deck = seededShuffle(deck, state.name||'guest');
      state.idx = 0; state.answers = [];
    }

    // ============== UI flow ==============
    function startApp(){
      const nm = ($('#nameInput').value||'').trim(); if(!nm){ alert('‘≥÷Ä’´’õ÷Ä ’°’∂’∏÷Ç’∂’® ‚úçÔ∏è'); return; }
      state.name = nm; saveLS('ff_name', nm);
      buildDeck();
      $('#userName').textContent = nm;
      $('#shown').textContent = '0';
      $('#welcome').classList.add('hidden');
      $('#quiz').classList.remove('hidden');
      showCurrent();
    }
    window.startApp=startApp;

    function showCurrent(){
      const item = state.deck[state.idx];
      if(!item){ return finishFlow(); }
      const catName = CATEGORIES.find(c=>c.id===item.cat).name;
      $('#catName').textContent = catName;
      $('#factCat').textContent = catName;
      $('#factText').textContent = item.text;
      $('#shown').textContent = String(state.idx+1>20?20:state.idx+1)+ '/20';
    }

    function nextFact(){
      if(state.idx < state.deck.length-1){ state.idx++; showCurrent(); }
      else { finishFlow(); }
    }
    window.nextFact=nextFact;

    function prevFact(){
      if(state.idx>0){ state.idx--; showCurrent(); }
    }
    window.prevFact=prevFact;

    function rate(q){
      const item = state.deck[state.idx];
      // Save/replace rating for this item index deterministically
      state.answers[state.idx] = { ...item, rating:q };
      // Auto-continue to next
      nextFact();
    }
    window.rate=rate;

    function finishFlow(){
      $('#quiz').classList.add('hidden');
      $('#finish').classList.remove('hidden');
      // Bootstrap one suggestion field if empty
      if(!state.suggestions.length) state.suggestions=[''];
      renderSuggestions();
    }

    // ============== Suggestions ==============
    function renderSuggestions(){
      const box = $('#suggestList'); box.innerHTML='';
      state.suggestions.forEach((val, i)=>{
        const wrap=document.createElement('div'); wrap.className='row'; wrap.style.marginBottom='8px';
        const label=document.createElement('div'); label.textContent = `‘±’º’°’ª’°÷Ä’Ø ${i+1}`; label.style.minWidth='110px'; label.className='muted';
        const input=document.createElement('input'); input.value=val; input.placeholder='’Å’•÷Ä ’°’º’°’ª’°÷Ä’Ø’®‚Ä¶'; input.oninput=()=>{ state.suggestions[i]=input.value; };
        const rm=document.createElement('button'); rm.className='btn danger'; rm.textContent='‚úï'; rm.onclick=()=>{ state.suggestions.splice(i,1); renderSuggestions(); };
        wrap.appendChild(label); wrap.appendChild(input); wrap.appendChild(rm);
        box.appendChild(wrap);
      });
    }
    function addSuggestion(){ state.suggestions.push(''); renderSuggestions(); }
    window.addSuggestion=addSuggestion;

    // ============== Report ==============
    function buildReportText(){
      const lines=[]; const now=new Date().toLocaleString();
      lines.push(`‘±’∂’∏÷Ç’∂: ${state.name}`);
      lines.push(`‘±’¥’Ω’°’©’´’æ/’™’°’¥: ${now}`);
      lines.push('');
      // Category stats
      const perCat={};
      for(const c of CATEGORIES){ perCat[c.id]={name:c.name, sum:0, n:0}; }
      state.answers.forEach(a=>{ if(!a) return; perCat[a.cat].sum+=a.rating||0; perCat[a.cat].n++; });
      lines.push('‘ø’°’ø’•’£’∏÷Ä’´’°’∂’•÷Ä’´ ’°’¥÷É’∏÷É’∏÷Ç’¥:');
      let bestCat=null, bestAvg=-1;
      for(const cid of Object.keys(perCat)){
        const {name,sum,n}=perCat[cid]; const avg = n? (sum/n).toFixed(2) : '‚Äî';
        lines.push(`- ${name}: ’¥’´’ª’´’∂ ${avg} (${n} ÷É’°’Ω’ø)`);
        if(n){ const v = sum/n; if(v>bestAvg){ bestAvg=v; bestCat=name; } }
      }
      lines.push(`‘º’°’æ’°’£’∏÷Ç’µ’∂ ’Ø’°’ø’•’£’∏÷Ä’´’°: ${bestCat||'‚Äî'}`);
      lines.push('');
      lines.push('’Ñ’°’∂÷Ä’°’¥’°’Ω’∂’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä (20 ÷É’°’Ω’ø) ‚Äî ’Ø’°÷Ä’£’∏’æ:');
      state.deck.forEach((it, i)=>{
        const a = state.answers[i];
        const catName = CATEGORIES.find(c=>c.id===it.cat).name;
        const r = a? a.rating : '‚Äî';
        lines.push(`${String(i+1).padStart(2,'0')}. [${catName}] ${it.text} => ‘≥’∂’°’∞’°’ø’°’Ø’°’∂: ${r}`);
      });
      lines.push('');
      lines.push('‘±’º’°’ª’°÷Ä’Ø’∂’•÷Ä:');
      const nonEmpty = (state.suggestions||[]).map(s=>s.trim()).filter(Boolean);
      if(nonEmpty.length){ nonEmpty.forEach((s,i)=> lines.push(`- ${i+1}) ${s}`)); }
      else { lines.push('‚Äî'); }
      return lines.join('\n');
    }

    function downloadReport(){
      const txt = buildReportText();
      const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `facts_report_${(state.name||'user').replace(/\s+/g,'_')}.txt`;
      a.click();
    }
    window.downloadReport=downloadReport;

    function reviewAnswers(){
      $('#reviewBox').textContent = buildReportText();
    }
    window.reviewAnswers=reviewAnswers;

    // Reset
    function resetAll(){ localStorage.clear(); location.reload(); }
    window.resetAll=resetAll;

    // ============== Boot ==============
    (function init(){
      if(state.name){ $('#nameInput').value=state.name; }
      // Auto-continue if user had name and no deck yet
      // (safer to start fresh anyway)
    })();

    // ============== Tests ==============
    (function runTests(){
      const out=[]; const ok=(c,m)=>{ out.push(`${c?'‚úÖ':'‚ùå'} ${m}`); if(!c) console.error(m); };
      try{
        ok(typeof startApp==='function','startApp is defined (fix for ReferenceError)');
        // Build a temporary deck for tests
        const tmpName='Tester';
        let tmpState={ name: tmpName, deck:[], idx:0, answers:[], suggestions:[''] };
        // simulate buildDeck using same logic
        (function buildDeckTest(){
          const cats=CATEGORIES.map(c=>c.id); const deck=[];
          for(const cat of cats){ const pool=FACTS[cat].slice(); const shuffled=seededShuffle(pool,tmpName); const take4=shuffled.slice(0,4); for(let i=0;i<take4.length;i++){ deck.push({id:`${cat}_${i}`,cat, text:take4[i]}); } }
          tmpState.deck = seededShuffle(deck,tmpName);
        })();
        ok(tmpState.deck.length===20,'Deck contains exactly 20 items');
        // Count per category == 4
        const counts={}; tmpState.deck.forEach(d=>{counts[d.cat]=(counts[d.cat]||0)+1;});
        ok(Object.values(counts).every(v=>v===4),'Each of 5 categories contributes 4 facts');
        // Download report smoke test
        ok(typeof downloadReport==='function','downloadReport is defined');
      }catch(e){ out.push('‚ùå Tests crashed: '+e.message); }
      const box=$('#testResults'); if(box) box.textContent=out.join('\n');
    })();
  </script>
</body>
</html>
